/*! burn 2017-05-11 */

var express=require("express"),router=express.Router();router.get("/",function(a,b,c){b.render("index",{title:"Express"})}),module.exports=router;var express=require("express"),router=express.Router(),blogDAO=require("./../dao/blogDAO"),blogSql=require("./../dao/sql/blogSql"),formidable=require("./../node_modules/formidable"),AVATAR_UPLOAD_FOLDER="/uploads/",blogCover="/blogCover/",createUnique=require("./../util/createUnique"),fs=require("fs");router.get("/",function(a,b,c){}),router.get("/getBlog",function(a,b,c){blogDAO.getBlog(function(a){a.length>0&&b.json({result:a})})}),router.get("/getBlogRecommend",function(a,b,c){blogDAO.getBlogRecommend(function(a){a.length>0&&b.json({result:a})})}),router.get("/getBlogDetail",function(a,b,c){var d=a.query;null!=d&&blogDAO.getBlogDetail(d.bid,function(a){b.json(a)})}),router.get("/getBlogComment",function(a,b,c){var d=a.query;null!=d&&blogDAO.getBlogComment(d.bid,function(a){b.json(a)})}),router.get("/insertBlogComment",function(a,b,c){console.log("insertBlogComment");var d=a.query;null!=d.bid&&blogDAO.insertBlogComment(d,function(a){b.json(a)})}),router.get("/insertBlogCollect",function(a,b,c){var d=a.query;null!=d.bid&&blogDAO.insertBlogCollect(d,function(a){b.json(a)})}),router.get("/getBlogCollect",function(a,b,c){var d=a.query;null!=d.bid&&blogDAO.getBlogCollect(d,function(a){console.log(a),b.json(a)})}),router.get("/updateBlogLike",function(a,b,c){var d=a.query;null!=d.bid&&blogDAO.updateBlogLike(d,function(a){b.json(a)})}),router.post("/insertBlog",function(a,b,c){var d=new formidable.IncomingForm;d.parse(a,function(a,c,e){var f=c.blogtxt;switch(console.log("文件后缀名为 "+e.file.type),e.file.type){case"image/jpeg":extName="jpeg";break;case"image/jpg":extName="jpg";break;case"image/png":case"image/x-png":extName="png"}if(0==extName.length)return void b.send("只支持png和jpg格式图片");d.uploadDir="../public"+blogCover,d.keepExtensions=!0,d.maxFieldsSize=2048;var g=createUnique.creatName()+"."+extName,h=d.uploadDir+g,i=fs.createReadStream(e.file.path),j=fs.createWriteStream(h);i.pipe(j),i.on("end",function(){fs.unlinkSync(e.file.path)});var k=JSON.parse(f);k.bpic=g,f[0].bpic=g,blogDAO.insertBlog(k,function(a){console.log({result:a}),b.json({result:a})})})}),router.get("/getBlogByuid",function(a,b,c){var d=a.query;null!=d.uid&&blogDAO.getBlogByuid(d,function(a){b.json({result:a})})}),router.get("/getBlogKeep",function(a,b,c){var d=a.query;null!=d.uid&&blogDAO.getBlogKeep(d,function(a){b.json({result:a})})}),router.get("/deleteBlogCollect",function(a,b,c){var d=a.query;null!=d.bkid&&blogDAO.deleteBlogCollect(d,function(a){b.json({result:a})})}),module.exports=router;